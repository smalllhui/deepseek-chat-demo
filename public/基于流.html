<!DOCTYPE html>
<html lang="zh-CN">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DeepSeek èŠå¤©æ¼”ç¤º-åŸºäºæµ</title>
<script type="module">
  // é€šè¿‡ CDN å¼•å…¥EventSourceï¼ˆESM æ ¼å¼ï¼‰
  import { fetchEventSource } from 'https://cdn.jsdelivr.net/npm/@fortaine/fetch-event-source@3.0.6/+esm'
  Window.fetchEventSource = fetchEventSource // æŒ‚è½½åˆ°Windowä¸Š
</script>
<!-- Markdown æ¸²æŸ“åº“ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- ä»£ç é«˜äº®åº“ å®˜æ–¹ CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<style>
  :root {
    --primary-color: #2d8cf0;
    --bot-bg: #f5f5f5;
    --user-bg: #e6f7ff;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f8f9fa;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .chat-container {
    max-width: 800px;
    margin: 20px auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    flex: 1;
    display: flex;
    flex-direction: column;
    width: 95%;
  }

  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 15px;
    line-height: 1.5;
    animation: fadeIn 0.3s ease;
  }

  .bot-message {
    background: var(--bot-bg);
    align-self: flex-start;
    border-bottom-left-radius: 3px;
  }

  .user-message {
    background: var(--user-bg);
    align-self: flex-end;
    border-bottom-right-radius: 3px;
  }

  .typing-indicator {
    display: none;
    padding: 12px;
    color: #666;
    font-style: italic;
  }

  .input-container {
    border-top: 1px solid #eee;
    padding: 15px;
    display: flex;
    gap: 10px;
  }

  #messageInput {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    resize: none;
    min-height: 48px;
    max-height: 120px;
  }

  #sendButton {
    padding: 0 20px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  #sendButton:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .stop {
    align-items: center;
    display: flex;
    cursor: pointer;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 480px) {
    .message {
      max-width: 90%;
    }
  }
</style>
</head>

<body>
  <div class="chat-container">
    <div class="messages" id="messages"></div>
    <div class="typing-indicator" id="typing">DeepSeek æ­£åœ¨è¾“å…¥...</div>
    <div class="input-container">
      <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" @keydown="handleKeyDown"></textarea>
      <!-- sendMessageByFetch() sendMessageByEventSource() -->
      <button id="sendButton" onclick="sendMessageByEventSource()">å‘é€</button>
      <span class="stop" onclick="cancelRequest()">ğŸŸ¥</span>
    </div>
  </div>

  <script>
    let ctrl; // ç”¨äºä¸­æ–­è¯·æ±‚

    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('messageInput');
    inputEl.value = "å†™ä¸€ä¸ªå†’æ³¡æ’åº" // ç»™inputèµ‹åˆå§‹å€¼
    const sendBtn = document.getElementById('sendButton');
    const typingEl = document.getElementById('typing');

    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = inputEl.scrollHeight + 'px';
    });

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
    function addMessage(content, isUser) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
      messageDiv.textContent = content;
      messagesEl.appendChild(messageDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // é€šè¿‡fetchå‘é€æ¶ˆæ¯åˆ°åç«¯ å¹¶ä¸”æ¥æ”¶åç«¯è¿”å›çš„æµæ•°æ®
    async function sendMessageByFetch() {
      const content = inputEl.value.trim();
      if (!content || sendBtn.disabled) return;

      // æ¸…ç©ºè¾“å…¥æ¡†
      inputEl.value = '';
      inputEl.style.height = 'auto';
      sendBtn.disabled = true;

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addMessage(content, true);

      // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æç¤º
      typingEl.style.display = 'block';
      messagesEl.scrollTop = messagesEl.scrollHeight;
      console.log("ç”¨æˆ·è¯·æ±‚æ•°æ®:", content)
      ctrl = new AbortController()
      try {
        // è°ƒç”¨åç«¯æµå¼API 
        const response = await fetch('http://127.0.0.1:4000/api/ai/chat-stream-deepseek', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: content
          }),
          signal: ctrl.signal,
        })

        // å¤„ç†æµå¼æ•°æ®
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let botResponse = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value);
          const lines = chunk.split('\n').filter(l => l.trim());
          for (const line of lines) {
            const message = line.replace(/^data: /, '');
            if (message === '[DONE]') break;
            try {
              const data = JSON.parse(message);
              botResponse += data.content;
              // å®æ—¶æ›´æ–° UI(å¦‚é€è¯æ˜¾ç¤º)
              const lastMsg = messagesEl.lastChild;
              if (lastMsg && !lastMsg.classList.contains('user-message')) {
                lastMsg.innerHTML = marked.parse(botResponse)
                hljs.highlightAll(); // é‡æ–°é«˜äº®ä»£ç å—
              } else {
                addMessage(marked.parse(botResponse), false);
              }
              messagesEl.scrollTop = messagesEl.scrollHeight;
            } catch (e) {
              console.error('è§£æé”™è¯¯:', e);
            }
          }
        }
      } catch (error) {
        if (!error.name === 'AbortError') // è‡ªå·±ç‚¹å‡»ä¸­æ–­
          addMessage(`è¯·æ±‚å¤±è´¥: ${error.message}`, false);
      } finally {
        typingEl.style.display = 'none';
        sendBtn.disabled = false;
      }
    }

    // é€šè¿‡EventSourceå‘é€æ¶ˆæ¯åˆ°åç«¯ å¹¶ä¸”æ¥æ”¶åç«¯è¿”å›çš„æµæ•°æ®
    async function sendMessageByEventSource() {
      const content = inputEl.value.trim();
      if (!content || sendBtn.disabled) return;

      // æ¸…ç©ºè¾“å…¥æ¡†
      inputEl.value = '';
      inputEl.style.height = 'auto';
      sendBtn.disabled = true;

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addMessage(content, true);

      // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æç¤º
      typingEl.style.display = 'block';
      messagesEl.scrollTop = messagesEl.scrollHeight;

      console.log("ç”¨æˆ·è¯·æ±‚æ•°æ®:", content)
      ctrl = new AbortController()
      let botResponse = '';//è¿”å›æ•°æ®
      // åˆ›å»º EventSource å®ä¾‹ï¼ˆæ”¯æŒ POSTï¼‰
      Window.fetchEventSource('http://127.0.0.1:4000/api/ai/chat-stream-deepseek', {
        method: 'POST',       // ä½¿ç”¨ POST æ–¹æ³•
        headers: {
          'Content-Type': 'application/json',  // è¯·æ±‚å¤´
        },
        body: JSON.stringify({
          message: content
        }), // POST æ•°æ®
        signal: ctrl.signal,// ç»‘å®šä¸­æ–­ä¿¡å·
        onopen: async (response) => {
          // è¿æ¥æˆåŠŸæ—¶è§¦å‘
          console.log('SSE è¿æ¥å·²å»ºç«‹ï¼ŒçŠ¶æ€ç :', response.status);
          if (response.ok) return;         // æ­£å¸¸æƒ…å†µç»§ç»­å¤„ç†
          throw new Error('è¿æ¥å¤±è´¥');
        },
        onmessage: (event) => {
          // æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯æ—¶è§¦å‘
          console.log('æ”¶åˆ°äº‹ä»¶:', event.data);
          const data = JSON.parse(event.data)
          botResponse += data.content;
          // å®æ—¶æ›´æ–° UI(å¦‚é€è¯æ˜¾ç¤º)
          const lastMsg = messagesEl.lastChild;
          if (lastMsg && !lastMsg.classList.contains('user-message')) {
            lastMsg.innerHTML = marked.parse(botResponse)
            hljs.highlightAll(); // é‡æ–°é«˜äº®ä»£ç å—
          } else {
            addMessage(marked.parse(botResponse), false);
          }
          messagesEl.scrollTop = messagesEl.scrollHeight;
        },
        onerror: (err) => {
          // å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ï¼ˆè‡ªåŠ¨é‡è¯•ï¼‰
          console.error('SSE é”™è¯¯:', err);
          addMessage(`è¯·æ±‚å¤±è´¥`, false);
          throw err; // æŠ›å‡ºé”™è¯¯åœæ­¢é‡è¯•
        },
        onclose: () => {
          // è¿æ¥å…³é—­æ—¶è§¦å‘
          console.log('SSE è¿æ¥å·²å…³é—­');
          typingEl.style.display = 'none';
          sendBtn.disabled = false;
        }
      });
    }

    // å–æ¶ˆè¯·æ±‚
    function cancelRequest() {
      if (!ctrl) {
        return
      }
      console.log("å–æ¶ˆè¯·æ±‚")
      ctrl.abort();
      typingEl.style.display = 'none';
      sendBtn.disabled = false;
    }
  </script>
</body>

</html>